name: CI
on:
  pull_request:
jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
      - name: Install linters (yamlfmt, ktlint, detekt)
        env:
          YAMLFMT_VERSION: "0.21.0"
          KTLINT_VERSION: "1.8.0"
          DETEKT_VERSION: "1.23.8"
        run: |
          set -euo pipefail
          mkdir -p .ci/bin
          echo "$(pwd)/.ci/bin" >> "$GITHUB_PATH"
          export PATH="$(pwd)/.ci/bin:$PATH"

          curl -sSLo /tmp/yamlfmt.tar.gz "https://github.com/google/yamlfmt/releases/download/v${YAMLFMT_VERSION}/yamlfmt_${YAMLFMT_VERSION}_Linux_x86_64.tar.gz"
          tar xzf /tmp/yamlfmt.tar.gz -C .ci/bin yamlfmt
          chmod +x .ci/bin/yamlfmt

          curl -sSLo .ci/bin/ktlint "https://github.com/pinterest/ktlint/releases/download/${KTLINT_VERSION}/ktlint"
          chmod +x .ci/bin/ktlint

          curl -sSLo /tmp/detekt.zip "https://github.com/detekt/detekt/releases/download/v${DETEKT_VERSION}/detekt-cli-${DETEKT_VERSION}.zip"
          unzip -q /tmp/detekt.zip -d .ci
          ln -sf "$(pwd)/.ci/detekt-cli-${DETEKT_VERSION}/bin/detekt-cli" .ci/bin/detekt
          chmod +x .ci/bin/detekt

          yamlfmt --version
          ktlint --version
          detekt --version
      - name: Run yamlfmt
        run: yamlfmt -lint .
      - name: Run ktlint
        run: ktlint --relative "**/*.kt" "**/*.kts" "!**/bin/**" "!**/build/**"
      - name: Run detekt
        run: detekt --input modules --excludes "**/bin/**,**/build/**" --config gradle-config/detekt.yml --build-upon-default-config --parallel --base-path .
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      - name: Run tests
        run: ./gradlew test
  build-image:
    name: Build Production Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build production Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./resources/docker/app.Dockerfile
          push: false
          tags: kotlin-ktor-postgres-template-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
